[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Этот проект распространяется под лицензией MIT.  
Вы можете свободно использовать, модифицировать и распространять скрипт,  
при условии сохранения уведомления об авторских правах и текста лицензии.

# ZIMBRA LOGS → TELEGRAM NOTIFIER (CRON)

## Назначение

Скрипт предназначен для отправки ежедневного отчёта в Telegram по итогам работы Zimbra-скриптов:

1) какие учетные записи были переведены в статус `closed` (берётся из лога отключений)
2) какие учетные записи были удалены по сроку давности (берётся из отчёта удаления)

Скрипт безопасен для запуска из cron, умеет делить отчёт на несколько сообщений (чанков), экранирует спецсимволы Markdown и при успешной отправке очищает исходные логи.

---

## Как работает (общая логика)

1) Читает строки из двух файлов логов:
   - LOG_FILE: лог отключённых сегодня ящиков (не пустые строки)
   - DEL_FILE: лог удалённых ящиков (не пустые строки, формат `email;date`)

2) Из DEL_FILE формирует человекочитаемые строки вида:
   `user@domain.ru (удалено: YYYY-MM-DD ...)`

3) Склеивает оба набора строк в единый список `total_lines`.

4) Делит общий список на сообщения по `MAX_LINES_PER_MESSAGE` строк (по умолчанию 50).

5) Для каждого чанка формирует сообщение:
   - добавляет заголовок для раздела "Отключены..." при первом попадании строки из disable-лога
   - добавляет заголовок для раздела "Удалены..." при первом попадании строки из delete-отчёта
   - добавляет строки отчёта, предварительно экранируя спецсимволы Markdown

6) Отправляет каждый чанк в Telegram через Bot API методом `sendMessage`.

7) Если все чанки отправлены успешно:
   - очищает оба исходных файла логов (делает их пустыми)

   Если хотя бы один чанк отправить не удалось:
   - логи не очищаются (чтобы отчёт не потерялся)

---

## Переменные и пути

### Telegram

- BOT_TOKEN — токен Telegram-бота, который отправляет сообщения
- CHAT_ID   — ID чата/канала/группы, куда отправляется отчёт

ВАЖНО:
- BOT_TOKEN нельзя публиковать в открытых репозиториях.
- Рекомендуется хранить токен в отдельном конфиге или переменных окружения.

### Файлы логов

- LOG_FILE   = `/opt/zimbra/logs/zimbra_disable_today.log`
  Источник: список отключённых сегодня учётных записей (любые строки)

- DEL_FILE   = `/opt/zimbra/logs/deleted_accounts_report.log`
  Источник: список удалённых учётных записей в формате:
  `Email;Date` (заголовок допускается)
  `user@domain.ru;2025-01-01 ...`

- DEBUG_LOG  = `/opt/zimbra/logs/cron_telegram_debug.log`
  Отладочный лог: запуск, ответы Telegram API, ошибки, факт очистки логов

### Настройка чанков

- MAX_LINES_PER_MESSAGE = 50
  Максимальное количество строк отчёта в одном Telegram-сообщении.

---

## Формат входных данных

### LOG_FILE (отключения)

Скрипт берёт все непустые строки как есть.
Пример:

`user1@domain.ru`
` неактивна с 14.06.2022`
`user2@domain.ru`
` Увольнение 23.10.2024`

---

### DEL_FILE (удаления)

Ожидаемый формат строк:

`email;date`

Особенности:
- пустые строки игнорируются
- строка с email равным `Email` игнорируется (как заголовок)

Пример:

`Email;Date`
`olduser@domain.ru;2025-12-01`
`unused@domain.ru;2025-12-02`

В итоговом сообщении будет:

`olduser@domain.ru (удалено: 2025-12-01)`
`unused@domain.ru (удалено: 2025-12-02)`

---

## Telegram сообщение (структура)

В сообщении используются заголовки Markdown:

- `*Отключены следующие учётные записи Zimbra за сегодня:*`
- `*Удалены следующие учётные записи по сроку давности (не используются более одного (1) года):*`

Далее идут строки отчёта (email/текст).

---

## Экранирование Markdown

Чтобы Telegram не ломал вывод, перед отправкой экранируются спецсимволы:

- `\` (обратный слэш)
- `_`
- `*`
- `[`
- `]`
- `` ` ``

Это защищает от ошибок `parse_mode=Markdown` и неожиданного форматирования.

---

## Очистка логов

Если Telegram вернул `"ok":true` для всех чанков:
- `LOG_FILE` очищается (становится пустым)
- `DEL_FILE` очищается (становится пустым)

Если отправка не удалась хотя бы на одном чанке:
- файлы НЕ очищаются (данные сохраняются для повторного запуска)

---

## Пример запуска

Ручной запуск:

`/opt/zimbra/scripts/zimbra_telegram_notify.sh`

---

## Запуск из cron

Пример ежедневного запуска в 08:50:

`crontab -e`

`50 8 * * * /opt/zimbra/scripts/zimbra_telegram_notify.sh`

Рекомендация:
- запускать после основного скрипта отключения/удаления, чтобы логи уже были сформированы.

---

## Требования

- bash (Linux)
- curl
- Доступ в интернет к `https://api.telegram.org`
- Права на чтение LOG_FILE и DEL_FILE
- Права на запись DEBUG_LOG
- Права на очистку LOG_FILE и DEL_FILE (оператор `> file`)

---

## Безопасность (обязательно)

- Не храните BOT_TOKEN в публичном репозитории.
- В идеале:
  - вынести BOT_TOKEN и CHAT_ID в отдельный конфиг (не коммитить)
  - или получать из переменных окружения / секретов CI/CD

---

## Статус

- Готов к использованию в production
- Безопасен для cron
- Делит отчёт на чанки (по 50 строк)
- Экранирует Markdown
- Очищает логи только при успешной отправке
